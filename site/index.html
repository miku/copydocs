<!DOCTYPE html>
<html>
<head>
    <title>Hi</title>

    <!-- Basic Page Needs
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>copydocs</title>
    <meta name="description" content="copydocs">
    <meta name="author" content="copydocs">

    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- FONT
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <!-- CSS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/app.css">

    <!-- Favicon
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="images/favicon.png">

    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/mustache.min.js" ></script>
    <script src="js/sugar.min.js"></script>
    <script src="js/elasticsearch.jquery.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            // console.log( "ready!" );

            function truncate(string, length){
               if (string.length > length)
                  return string.substring(0, length) + '...';
               else
                  return string;
            };

            // main entry point
            $("#q").focus();

            // update on search
            $("#q").keyup(function(e) {

                // if (e.KeyCode == 13) {
                //     console.log("ENTER");
                // }

                var queryString = $("#q").val();
                // console.log(queryString);

                var client = new $.es.Client({
                  hosts: 'http://localhost:9200'
                });

                var searchParams = {
                    index: 'sample',
                    size: 100,
                    body: {
                        query: {
                            query_string: {
                                query: queryString
                            }
                        },
                        highlight: {
                            fields: {
                                '*': {}
                            }
                        }                        
                    }
                }

                client.search(searchParams).then(function (body) {
                    // success
                    var results = Array();

                    // assemble documents
                    for (var i = 0; i < body.hits.hits.length; i++) {
                        var hit = body.hits.hits[i];
                        var entry = {
                            'title' : hit._source.info.title,
                            'url' : hit._source.page.url,
                            'abstract': truncate(hit._source.page.abstract, 300),
                            'year': hit._source.info.year,
                        }
                        results.push(entry);
                    }
                        
                    // mustachio
                    var template = $('#template').html();
                    var rendered = Mustache.render(template, {
                        results: results
                    });

                    // replace #r completely
                    $('#r').html(rendered);

                    // update count
                    $('#count').html(body.hits.total);

                }, function (error) {
                    // fail
                    console.trace(error.message);
                });
            });
        });

    </script>
</head>

<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">
        <div class="row">
            <div class="ten columns">
                <h1>copydocs</h1>
                <p>Search through copyright relevant documents quickly.</p>
                <!-- input -->
                <input id="q" class="u-full-width" type="text" name="search">

                <p><span id="count">0</span> result(s).</p>

                <!-- results -->
                <ul id="r">
                </ul>

                <script id="template" type="x-tmpl-mustache">
                    {{#results}}
                        <li>
                            <b>{{ title }}</b> &mdash; {{ year }}<br>
                            <a href="{{ url }}">{{ url }}</a><br>
                            {{ abstract }}

                        </li>
                    {{/results}}
                </script>
                
            </div>
        </div>
  </div>

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    


</body>
</html>
