<!DOCTYPE html>
<html>
<head>
    <title>Hi</title>

    <!-- Basic Page Needs
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta charset="utf-8">
    <title>copydocs</title>
    <meta name="description" content="copydocs">
    <meta name="author" content="copydocs">

    <!-- Mobile Specific Metas
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- FONT
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <!-- CSS
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/app.css">

    <!-- Favicon
    –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="images/favicon.png">

    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/mustache.min.js" ></script>
    <script src="js/sugar.min.js"></script>
    <script src="js/jquery.debounce.js"></script>
    <script src="js/elasticsearch.jquery.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            // console.log( "ready!" );

            function truncate(string, length){
               if (string.length > length)
                  return string.substring(0, length) + '...';
               else
                  return string;
            };

            // main entry point
            $("#q").focus();

            // update on search
            $("#q").keyup($.debounce(function(e) {

                // if (e.KeyCode == 13) {
                //     console.log("ENTER");
                // }

                var queryString = $("#q").val();
                // console.log(queryString);

                var client = new $.es.Client({
                  hosts: 'http://localhost:9200'
                });

                var searchParams = {
                    index: 'sample',
                    size: 100,
                    body: {
                        query: {
                            query_string: {
                                query: queryString
                            }
                        },
                        sort: [
                            {"info.year": {"order": "desc"}},
                            "_score"
                        ],
                        highlight: {
                            fields: {
                                '*': {
                                    "fragment_size" : 250,
                                    "number_of_fragments" : 3
                                }
                            },
                            require_field_match: false
                        },
                        aggs: {
                            year: {
                                terms: {
                                    field: "info.year",
                                }
                            }
                        }
                    }
                }

                client.search(searchParams).then(function (body) {
                    // success
                    var results = Array();

                    console.log(body);


                    // ====================================

                    // set filters from aggs
                    // collect year filters here
                    var fvals = Array();

                    var buckets = body.aggregations.year.buckets;
                    for (var i = 0; i < buckets.length; i++) {
                        var b = buckets[i];
                        fvals.push({
                            "key": b.key,
                            "value": b.doc_count,
                        })
                    }

                    console.log(fvals);

                    // mustachio
                    var template = $('#filtertemplate').html();
                    var rendered = Mustache.render(template, {
                        fvals: fvals,
                    });

                    // replace #f completely
                    $('#f').html(rendered);

                    // ====================================

                    // assemble documents
                    for (var i = 0; i < body.hits.hits.length; i++) {
                        var hit = body.hits.hits[i];

                        // console.log(hit);

                        // default abstract
                        var abstract = truncate(hit._source.page.abstract, 300);
                        // if we have a highlight, use that
                        if (hit.highlight.hasOwnProperty("page.abstract")) {
                            abstract = hit.highlight["page.abstract"];
                        }

                        // default title
                        var title = truncate(hit._source.info.title, 300);
                        // if we have a highlight, use that
                        if (hit.highlight.hasOwnProperty("info.title")) {
                            title = hit.highlight["info.title"];
                        }

                        // fulltext
                        var fulltext = truncate(hit._source.page.text, 300);
                        // if we have a highlight, use that
                        if (hit.highlight.hasOwnProperty("page.text")) {
                            fulltext = hit.highlight["page.text"];
                        }

                        var entry = {
                            title: title,
                            'url' : hit._source.page.url,
                            abstract: abstract,
                            'year': hit._source.info.year,
                            'fulltext': fulltext,
                        }

                        if (hit._source.page.linked_pdfs.length > 0) {
                            entry['pdf'] = hit._source.page.linked_pdfs[0];
                        }

                        results.push(entry);
                    }
                        
                    // mustachio
                    var template = $('#template').html();
                    var rendered = Mustache.render(template, {
                        results: results
                    });

                    // replace #r completely
                    $('#r').html(rendered);

                    // update count
                    $('#count').html(body.hits.total);

                }, function (error) {
                    // fail
                    console.trace(error.message);
                });
            }, 300));
        });

    </script>
</head>

<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">
        <div class="row">
            <div class="ten columns">
                <h1>CopyDocs</h1>
                <p>Search through copyright relevant documents quickly.</p>
                <!-- input -->
                <input id="q" class="u-full-width" type="text" name="search">

                <p><span id="count">0</span> result(s).</p>


                <!-- filters -->
                <ul id="f"></ul>

                <script id="filtertemplate" type="x-tmpl-mustache">
                    {{#fvals}}
                        <li>
                            {{ key }} -- {{ value }}
                        </li>
                    {{/fvals}}
                </script>

                <!-- results -->
                <ul id="r"></ul>

                <script id="template" type="x-tmpl-mustache">
                    {{#results}}
                        <li class="item">
                            <b>{{{ title }}}</b> &mdash; {{ year }}<br>
                            <a href="{{ url }}">{{ url }}</a><br>
                            {{{ abstract }}}
                            <br>
                            <hr>
                            <a href="{{ pdf }}">{{ pdf }}</a>
                            {{{ fulltext }}}
                        </li>
                    {{/results}}
                </script>
                
            </div>
        </div>
  </div>

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    


</body>
</html>
